//tessel
var tessel = require('tessel');
//climate module
var climatelib = require('climate-si7020');
//ir module
var infraredlib = require('ir-attx4');
//plug climate module in portB
var climate = climatelib.use(tessel.port['B']);
//plug ir module in portA
var infrared = infraredlib.use(tessel.port['A']);
//record current temperature
var temperature;

// When we're connected
infrared.on('ready', function() {
  console.log("Connected to IR!");
  // Start sending a signal every three seconds
  // poweron buffer
  var powerBufferOn = new Buffer([0x48,0xf9,0x5c,0x1,0x90,0xfa,0xec,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0xc2,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfa,0xec,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0xc2,0xfe,0x3e,0x1,0xc2,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1]);
  //poweroff buffer
  var powerBufferOff = new Buffer([0x48,0xf9,0x8e,0x1,0xc2,0xfb,0x1e,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfd,0xda,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0xc2,0xfe,0xc,0x1,0x90,0xfb,0x1e,0x1,0x90,0xfe,0xc,0x1,0xc2,0xfe,0x3e,0x1,0xc2,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1,0xc2,0xfe,0xc,0x1,0x90,0xfe,0xc,0x1]);
    
  setInterval(function () {
    //open airconditioner if current temperature is higher than 30 celsius degree
    if(temperature > 30){
      infrared.sendRawSignal(38, powerBufferOn, function(err) {
        if (err) {
          console.log("Unable to send signal: ", err);
        } else {
          console.log("power on Signal sent!");
        }
      });
    }
    //close airconditioner if current temperature is lower than 26 celsius degree
    if(temperature < 26){
      infrared.sendRawSignal(38, powerBufferOff, function(err) {
        if (err) {
          console.log("Unable to send signal: ", err);
        } else {
          console.log("power off Signal sent!");
        }
      });
    }
   
  }, 3000); // Every 3 seconds
});

climate.on('ready', function () {
  console.log('Connected to climate module');

  // Loop every minute
  setImmediate(function loop () {
    climate.readTemperature('f', function (err, temp) {
      climate.readHumidity(function (err, humid) {
      temperature = ((temp-32)/9*5).toFixed(1);
      console.log("Current temperature: " + temperature);
      setTimeout(loop, 60000);
      });
    });
  });
});

climate.on('error', function(err) {
  console.log('error connecting module', err);
});